ekf_filter_node:
  ros__parameters:
    frequency: 10.0
    sensor_timeout: 0.3
    two_d_mode: true
    transform_time_offset: 0.0
    transform_timeout: 0.0
    print_diagnostics: false
    debug: false
    debug_out_file: /tmp/ekf_debug.txt

    # Frames
    map_frame: map
    odom_frame: odom
    base_link_frame: base_footprint
    world_frame: odom

    # Publish fused odom->base_footprint TF
    publish_tf: true

    # Wheel odometry input
    odom0: odom
    odom0_queue_size: 10
    odom0_nodelay: true
    odom0_differential: false
    odom0_relative: false
    # Use wheel pose x,y and linear x velocity only (no yaw from wheels due to slip)
    # States: [x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az]
    odom0_config: [true, true, false,
                   false, false, false,
                   true, false, false,
                   false, false, false,
                   false, false, false]

    # IMU input
    imu0: imu
    imu0_queue_size: 20
    imu0_nodelay: true
    imu0_differential: false
    imu0_relative: false
    imu0_remove_gravitational_acceleration: true
    # Use yaw, yaw rate, and linear acceleration from IMU (helps x,y via integration)
    imu0_config: [false, false, false,
                  false, false, true,
                  false, false, false,
                  false, false, true,
                  true,  true,  false]

    # LiDAR odometry input (from rf2o scan matching)
    odom1: rf2o_odom
    odom1_queue_size: 10
    odom1_nodelay: true
    odom1_differential: true      # use incremental yaw from LiDAR odom (no absolute pose jumps)
    odom1_relative: false
    # Use LiDAR-derived yaw only (extra constraint on IMU yaw); x,y from wheels + SLAM
    # States: [x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az]
    odom1_config: [false, false, false,
                   false, false, true,
                   false, false, false,
                   false, false, false,
                   false, false, false]

    # Initial estimate covariance (P0) for state vector
    # State order:
    # [x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az]
    # Diagonal-dominant 15x15 matrix (flattened, 15 values per row)
    initial_estimate_covariance: [
      0.25, 0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.25, 0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  1000000.0, 0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  1000000.0, 0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  1000000.0, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.03, 0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.1,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  1000000.0, 0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  1000000.0, 0.0,  0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  1000000.0, 0.0,   0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  1000000.0, 0.0,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.1,  0.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  1.0,  0.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  1.0,  0.0,
      0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   0.0,  0.0,  0.0,  1.0
    ]

    # Process noise covariance (Q) for state vector
    # Small but non-zero noise on vx and yaw (and vyaw) for responsiveness.
    process_noise_covariance: [
      0.001, 0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.001, 0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.003, 0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.1,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.1,   0.0,  0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.05, 0.0,  0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.05, 0.0,
      0.0,   0.0,   0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.0,  0.0,  0.0,   0.0,   0.0,  0.0,  0.05
    ]
